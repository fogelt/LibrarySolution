@page "/"
@using Library.Core.Models.Items
@using Library.Web.Services
@inject LibraryService LibraryService

<PageTitle>Library Dashboard</PageTitle>

<div class="container">
  <h1 class="my-4 text-center">📚 Library Management System</h1>

  <div class="row mb-5">
    <div class="col-md-4">
      <div class="card bg-primary text-white text-center p-3">
        <h3>@stats.Total</h3>
        <span>Total Items</span>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card bg-info text-white text-center p-3">
        <h3>@stats.Loaned</h3>
        <span>Items on Loan</span>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card bg-warning text-dark text-center p-3">
        <h3>@stats.MVP</h3>
        <span>Top Member</span>
      </div>
    </div>
  </div>

  <hr />

  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Catalog</h2>
    <div class="w-25">
      <input @bind="searchTerm" @bind:event="oninput" @onkeyup="HandleSearch" class="form-control"
             placeholder="Search title or author..." />
    </div>
  </div>

  @if (items == null)
  {
    <div class="d-flex justify-content-center">
      <div class="spinner-border text-primary" role="status"></div>
    </div>
  }
  else
  {
    <div class="row">
      @foreach (var item in items)
      {
        <div class="col-md-4 mb-4">
          <div class="card h-100 shadow-sm border-0">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <span class="badge bg-light text-dark border mb-2">@item.GetType().Name</span>
                <span class="badge @(item.IsAvailable ? "bg-success" : "bg-danger") mb-2">
                  @(item.IsAvailable ? "Available" : "Borrowed")
                </span>
              </div>
              <h5 class="card-title">@item.Title</h5>
              <h6 class="card-subtitle mb-2 text-muted">@item.Author (@item.PublishedYear)</h6>

              <p class="card-text small">
                @if (item is DVD d)
                {
                  <span>🎬 Playtime: @(d.DurationInSeconds / 60) mins</span>
                }
                @if (item is Magazine m)
                {
                  <span>📖 Issue #@m.IssueNumber</span>
                }
              </p>
            </div>
            <div class="card-footer bg-white border-top-0 pb-3">
              <button class="btn btn-outline-primary btn-sm w-100" disabled="@(!item.IsAvailable)">
                @(item.IsAvailable ? "Borrow Item" : "See Details")
              </button>
            </div>
          </div>
        </div>
      }
    </div>
  }
</div>

@code {
  private List<LibraryItem>? items;
  private (int Total, int Loaned, string MVP) stats;
  private string searchTerm = "";

  protected override async Task OnInitializedAsync()
  {
    // 1. Initial Data Setup
    await LibraryService.SeedDataAsync();

    // 2. Load Data
    await LoadData();
  }

  private async Task LoadData()
  {
    items = await LibraryService.GetAllItemsAsync();
    stats = await LibraryService.GetStatisticsAsync();
  }

  private async Task HandleSearch()
  {
    if (string.IsNullOrWhiteSpace(searchTerm))
    {
      items = await LibraryService.GetAllItemsAsync();
    }
    else
    {
      items = await LibraryService.SearchItemsAsync(searchTerm);
    }
  }
}