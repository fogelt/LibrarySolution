@rendermode InteractiveServer
@page "/"
@using Library.Core.Models.Items
@using Library.Web.Services
@inject LibraryService LibraryService

<PageTitle>Library Dashboard</PageTitle>

<div class="container">
  <h1 class="my-4 text-center">The Library</h1>

  <div class="row mb-5">
    <div class="col-md-4">
      <div class="card bg-light text-dark text-center p-3">
        <h3>@stats.Total</h3>
        <span>Total Items</span>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card bg-light text-dark text-center p-3">
        <h3>@stats.Loaned</h3>
        <span>Items on Loan</span>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card bg-light text-dark text-center p-3">
        <h3>@stats.MVP</h3>
        <span>Top Member</span>
      </div>
    </div>
  </div>

  <hr />

  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Catalog</h2>
    <div class="w-25">
      <input type="text" class="form-control" placeholder="Search title or author..." value="@searchTerm"
             @oninput="OnSearchInput" />
    </div>
  </div>

  @if (items == null)
  {
    <div class="d-flex justify-content-center">
      <div class="spinner-border text-primary" role="status"></div>
    </div>
  }
  else
  {
    <div class="row">
      @foreach (LibraryItem item in items)
      {
        <div class="col-md-4 mb-4">
          <div class="card h-100 shadow-md bg-light">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <span class="badge bg-dark text-light border-0">@item.GetType().Name</span>
                <div class="rounded-circle @(item.IsAvailable ? "bg-success" : "bg-danger")"
                     style="width: 14px; height: 14px; border: 2px solid white; box-shadow: 0 0 2px rgba(0,0,0,0.2);"
                     title="@(item.IsAvailable ? "Available" : "Borrowed")">
                </div>
              </div>
              <h5 class="card-title mt-2">@item.Title</h5>
              <h6 class="card-subtitle mb-2 text-muted">@item.Author (@item.PublishedYear)</h6>

              <p class="card-text small text-muted mt-1">
                @if (item is DVD d)
                {
                  <span>Playtime: @(d.DurationInSeconds / 60) mins</span>
                }
                @if (item is Magazine m)
                {
                  <span>Issue #@m.IssueNumber</span>
                }
                @if (item is Book b)
                {
                  <span>Pages: @b.NumberOfPages</span>
                }
              </p>
            </div>
            <div class="card-footer bg-white border-top-0 pb-3">
              <button class="btn btn-outline-dark btn-sm w-100" disabled="@(!item.IsAvailable)">
                @(item.IsAvailable ? "Borrow Item" : "See Details")
              </button>
            </div>
          </div>
        </div>
      }
    </div>
  }
</div>

@code {
  private List<LibraryItem>? items;
  private (int Total, int Loaned, string MVP) stats;
  private string searchTerm = "";

  protected override async Task OnInitializedAsync()
  {
    await LoadData();
  }

  private async Task LoadData()
  {
    items = await LibraryService.GetAllItemsAsync();
    stats = await LibraryService.GetStatisticsAsync();
  }

  private async Task OnSearchInput(ChangeEventArgs e)
  {
    // If searchbar is empty fetch from DB, All Library items searchable with built in 'Matches'
    string? lastSearch = searchTerm;
    searchTerm = e.Value?.ToString() ?? "";

    if (string.IsNullOrWhiteSpace(searchTerm))
    {
      items = await LibraryService.GetAllItemsAsync();
    }
    else if (searchTerm.Length > lastSearch.Length && items != null)
    {
      items = items.Where(i => i.Matches(searchTerm)).ToList();
    }
  }
}