@rendermode InteractiveServer
@page "/catalog"
@using Library.Core.Models.Items
@using Library.Web.Components.UI
@using Library.Core.Interfaces
@inject ILibraryService LibraryService
@inject NavigationManager Navigation

<PageTitle>Library Catalog</PageTitle>

<div class="d-flex flex-column align-items-center mb-5 gap-4">
  <div style="width: 100%; max-width: 500px;">
    <input type="text" class="form-control glass-input py-2 text-center" placeholder="Search in the library..."
           value="@searchTerm" @oninput="OnSearchInput" />
  </div>
</div>

<div class="d-flex justify-content-between align-items-center w-100 gap-2">
  <div class="dropdown">
    <button class="glass-card dropdown-toggle px-3 px-md-4 py-2 text-white opacity-75" type="button"
            data-bs-toggle="dropdown">
      <i class="bi bi-sort-down me-2"></i>Sort By: @sortBy
    </button>
    <ul class="dropdown-menu dropdown-menu-dark glass-card border-white border-opacity-10 shadow-lg cursor-pointer">
      <li><a class="dropdown-item py-2 opacity-50 hover-opacity-100" @onclick='() => SetSort("Title")'>Title</a></li>
      <li><a class="dropdown-item py-2 opacity-50 hover-opacity-100" @onclick='() => SetSort("Author")'>Author</a></li>
      <li><a class="dropdown-item py-2 opacity-50 hover-opacity-100" @onclick='() => SetSort("Year")'>Year</a></li>
    </ul>
  </div>

  <button class="btn btn-sm glass-card text-white px-3 px-md-4 py-2 border-white border-opacity-10"
          @onclick="() => showCreateModal = true">
    <i class="bi bi-bag-plus me-1 me-md-2"></i> <span class="d-none d-sm-inline">Add Item</span><span
    class="d-inline d-sm-none">Add</span>
  </button>
</div>

<div class="d-flex flex-wrap justify-content-center justify-content-md-between align-items-center gap-3 py-3">

  <div class="btn-group glass-card p-1 w-100 w-md-50">
    <button
    class="nav-link text-white px-2 px-md-4 py-1 flex-fill @(filterType == "All" ? "active opacity-100" : "opacity-50")"
    @onclick='() => SetFilter("All")'>All</button>

    <button
    class="nav-link text-white px-2 px-md-4 py-1 flex-fill @(filterType == "Book" ? "active opacity-100" : "opacity-50")"
    @onclick='() => SetFilter("Book")'>Books</button>

    <button
    class="nav-link text-white px-2 px-md-4 py-1 flex-fill @(filterType == "DVD" ? "active opacity-100" : "opacity-50")"
    @onclick='() => SetFilter("DVD")'>DVDs</button>

    <button
    class="nav-link text-white px-2 px-md-4 py-1 flex-fill @(filterType == "Magazine" ? "active opacity-100" : "opacity-50")"
    @onclick='() => SetFilter("Magazine")'>Magazines</button>
  </div>

</div>

@if (allItems == null)
{
  <div class="text-center py-5">
    <div class="spinner-grow text-light" role="status"></div>
  </div>
}
else
{
  <div class="row g-4 mb-5">
    @foreach (LibraryItem item in pagedItems)
    {
      <div class="col-md-4 position-relative">
        <LibraryItemCard Item="item" OnPressed="() => NavigateToDetails(item.ISBN)" />
        <button class="btn btn-sm position-absolute top-0 end-0 glass-card" @onclick="() => DeleteItem(item)"
                title="Delete">
          <i class="bi bi-trash"></i>
        </button>
      </div>
    }
  </div>
}

@if (totalPages > 1)
{
  <Pagination CurrentPage="currentPage" TotalPages="totalPages" OnPageChanged="HandlePageChange" />
}

@if (showCreateModal)
{
  <AddItemModal OnClose="() => showCreateModal = false" OnSave="HandleItemSaved" />
}

@code {
  private bool showCreateModal = false;
  private List<LibraryItem> allItems = new List<LibraryItem>();
  private string searchTerm = "";
  private string filterType = "All";
  private string sortBy = "Title";

  // Pagination State
  private int currentPage = 1;
  private int pageSize = 6;

  private IEnumerable<LibraryItem> DisplayItems
  {
    get
    {
      IEnumerable<LibraryItem>? result = allItems.AsEnumerable();

      if (filterType != "All")
        result = result.Where(i => i.GetType().Name == filterType);

      if (!string.IsNullOrWhiteSpace(searchTerm))
        result = result.Where(i => i.Matches(searchTerm));

      return sortBy switch
      {
        "Author" => result.OrderBy(i => i.Author),
        "Year" => result.OrderByDescending(i => i.PublishedYear),
        _ => result.OrderBy(i => i.Title)
      };
    }
  }

  private IEnumerable<LibraryItem> pagedItems => DisplayItems
      .Skip((currentPage - 1) * pageSize)
      .Take(pageSize);

  private int totalPages => (int)Math.Ceiling((double)DisplayItems.Count() / pageSize);

  protected override async Task OnInitializedAsync()
  {
    allItems = await LibraryService.GetAllItemsAsync();
  }

  private async Task LoadItems()
  {
    allItems = await LibraryService.GetAllItemsAsync();
  }
  private async Task HandleItemSaved()
  {
    showCreateModal = false;
    await LoadItems(); // Re-fetch from DB to show the new item
    StateHasChanged(); // Force UI update
  }
  private async Task DeleteItem(LibraryItem item)
  {
    await LibraryService.DeleteItemAsync(item.ISBN);
    await LoadItems();
  }

  // --- Methods with Page Resets ---
  private void OnSearchInput(ChangeEventArgs e)
  {
    searchTerm = e.Value?.ToString() ?? "";
    currentPage = 1;
  }

  private void SetFilter(string type)
  {
    filterType = type;
    currentPage = 1;
  }

  private void SetSort(string criteria)
  {
    sortBy = criteria;
    currentPage = 1;
  }

  private void HandlePageChange(int newPage) => currentPage = newPage;
  private void NavigateToDetails(string isbn)
  {
    Navigation.NavigateTo($"/catalog/{isbn}");
  }
}