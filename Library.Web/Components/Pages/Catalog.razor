@rendermode InteractiveServer
@page "/catalog"
@using Library.Core.Models.Items
@using Library.Web.Services
@inject LibraryService LibraryService

<PageTitle>Library Catalog</PageTitle>

<div class="d-flex justify-content-between align-items-end mb-4">
                      <h2 class="fw-light text-white m-0">Catalog</h2>
                      <div style="width: 300px;">
    <input type="text" class="form-control glass-input py-2" placeholder="Search title or author..." value="@searchTerm"
           @oninput="OnSearchInput" />
  </div>
</div>

@if (items == null)
{
  <div class="text-center py-5">
    <div class="spinner-grow text-light" role="status"></div>
  </div>
}
else
{
  <div class="row g-4">
    @foreach (var item in items)
    {
      <div class="col-md-4">
        <div class="card h-100 glass-card border-0">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-3">
              <span class="badge rounded-pill bg-white text-dark opacity-75">@item.GetType().Name</span>
              <div class="rounded-circle @(item.IsAvailable ? "bg-success" : "bg-danger") shadow-sm"
                   style="width: 12px; height: 12px; border: 2px solid rgba(255,255,255,0.5);"
                   title="@(item.IsAvailable ? "Available" : "Borrowed")">
              </div>
            </div>

            <h5 class="card-title fw-bold">@item.Title</h5>
            <h6 class="card-subtitle mb-3 opacity-75">@item.Author â€¢ @item.PublishedYear</h6>

            <div class="small opacity-50">
              @if (item is DVD d)
              {
                <span><i class="bi bi-clock"></i> @(d.DurationInSeconds / 60) mins</span>
              }
              else if (item is Magazine m)
              {
                <span>Issue #@m.IssueNumber</span>
              }
              else if (item is Book b)
              {
                <span>@b.NumberOfPages Pages</span>
              }
            </div>
          </div>
          <div class="card-footer bg-transparent border-0 pb-4">
            <button class="btn btn-sm w-100 @(item.IsAvailable ? "btn-light" : "btn-outline-light opacity-50")"
                    disabled="@(!item.IsAvailable)">
              @(item.IsAvailable ? "Borrow Now" : "Currently Out")
            </button>
          </div>
        </div>
      </div>
    }
  </div>
}

@code {
  private List<LibraryItem>? items;
  private (int Total, int Loaned, string MVP) stats;
  private string searchTerm = "";

  protected override async Task OnInitializedAsync()
  {
    await LoadData();
  }

  private async Task LoadData()
  {
    items = await LibraryService.GetAllItemsAsync();
    stats = await LibraryService.GetStatisticsAsync();
  }

  private async Task OnSearchInput(ChangeEventArgs e)
  {
    // If searchbar is empty fetch from DB, All Library items searchable with built in 'Matches'
    string? lastSearch = searchTerm;
    searchTerm = e.Value?.ToString() ?? "";

    if (string.IsNullOrWhiteSpace(searchTerm))
    {
      items = await LibraryService.GetAllItemsAsync();
    }
    else if (searchTerm.Length > lastSearch.Length && items != null)
    {
      items = items.Where(i => i.Matches(searchTerm)).ToList();
    }
  }
}