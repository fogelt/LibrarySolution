@using Library.Core.Models
@using Library.Core.Models.Items
@using Library.Web.Services
@inject ILibraryService LibraryService

<div class="modal fade show d-block"
     style="background: rgba(0,0,0,0.7); backdrop-filter: blur(15px); z-index: 9999; overflow-y: auto;" tabindex="-1"
     role="dialog">
  <div class="modal-dialog modal-lg modal-dialog-centered" style="z-index: 10000;">
    <div class="glass-card border-white border-opacity-10 shadow-lg p-0 overflow-hidden w-100"
         style="pointer-events: all;">

      <div class="p-4 border-bottom border-white border-opacity-10 d-flex justify-content-between align-items-center">
        <h4 class="text-white fw-bold opacity-50 m-0"><i class="bi bi-plus-circle me-2"></i>Add to Loans</h4>
        <button type="button" class="btn-close btn-close-white shadow-none" @onclick="OnClose"></button>
      </div>

      <div class="modal-body py-4">
        @if (!string.IsNullOrEmpty(errorMessage))
        {
          <div class="alert bg-danger bg-opacity-10 border-danger border-opacity-25 text-danger small py-2 mb-4">
            <i class="bi bi-exclamation-triangle me-2"></i> @errorMessage
          </div>
        }
        <div class="mb-4">
          <label class="form-label opacity-50 small fw-bold text-uppercase mb-2 d-block">Member</label>
          <div class="dropdown w-100">
            <button
              class="glass-card dropdown-toggle px-4 py-2 w-100 text-start d-flex justify-content-between align-items-center @(errorMessage != null && selectedMember == null ? "border-danger border-opacity-50" : "")"
              type="button" data-bs-toggle="dropdown">
              <span><i class="bi bi-person me-2 opacity-50"></i> @(selectedMember?.Name ?? "Select Member")</span>
            </button>
            <ul class="dropdown-menu dropdown-menu-dark glass-card border-white border-opacity-10 shadow-lg w-100"
                style="max-height: 200px; overflow-y: auto;">
              @foreach (Member m in Members)
              {
                <li><a class="dropdown-item py-2 opacity-50 hover-opacity-100"
                         @onclick="() => { selectedMember = m; errorMessage = null; }">@m.Name</a></li>
                }
              </ul>
            </div>
          </div>

          <div class="mb-4">
            <label class="form-label opacity-50 small fw-bold text-uppercase mb-2 d-block">Available Item</label>
            <div class="dropdown w-100">
              <button
                class="glass-card dropdown-toggle px-4 py-2 w-100 text-start d-flex justify-content-between align-items-center @(errorMessage != null && selectedItem == null ? "border-danger border-opacity-50" : "")"
                type="button" data-bs-toggle="dropdown">
                <span><i class="bi bi-book me-2 opacity-50"></i> @(selectedItem?.Title ?? "Select Item")</span>
              </button>
              <ul class="dropdown-menu dropdown-menu-dark glass-card border-white border-opacity-10 shadow-lg w-100"
                  style="max-height: 200px; overflow-y: auto;">
                @foreach (LibraryItem i in Items.Where(x => x.IsAvailable))
                {
                  <li><a class="dropdown-item py-2 opacity-50 hover-opacity-100"
                           @onclick="() => { selectedItem = i; errorMessage = null; }">@i.Title</a></li>
                  }
                </ul>
              </div>
            </div>
          </div>

          <div class="modal-footer border-0 pt-0">
            <button type="button" @onclick="HandleSubmit" class="btn glass-card px-4 flex-grow-1">
              <i class="bi bi-check2-circle me-2"></i>Register loan
            </button>
            <button type="button" class="btn glass-card px-4" @onclick="OnClose">
              Cancel
            </button>
          </div>
        </div>
      </div>
    </div>

@code {
  [Parameter] public List<Member> Members { get; set; } = new();
  [Parameter] public List<LibraryItem> Items { get; set; } = new();
  [Parameter] public EventCallback OnClose { get; set; }
  [Parameter] public EventCallback OnLoanCreated { get; set; }

  private Member? selectedMember;
  private LibraryItem? selectedItem;
  private string? errorMessage;

  private async Task HandleSubmit()
  {
    if (selectedMember is null || selectedItem is null)
    {
      errorMessage = "Please select both a member and an item to proceed.";
      return;
    }

    errorMessage = null;

    bool success = await LibraryService.BorrowItemAsync(selectedItem.ISBN, selectedMember.MemberId);

    if (success)
    {
      await OnLoanCreated.InvokeAsync();
      await OnClose.InvokeAsync();
    }
    else
    {
      errorMessage = "An error occurred while registering the loan. Please try again.";
    }
  }
}